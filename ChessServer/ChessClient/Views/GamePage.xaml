<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ChessClient.Views.GamePage"
             xmlns:vm="clr-namespace:ChessClient.ViewModels"
             xmlns:models="clr-namespace:ChessClient.Models.Board"
             xmlns:converters="clr-namespace:ChessClient.Utilities.Converters"
             xmlns:behaviors="clr-namespace:ChessClient.Behaviors" 
             x:DataType="vm:GameViewModel"
             Title="Chess Game"
             x:Name="CurrentPage">

    <ContentPage.Resources>
        <Style TargetType="Frame">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="HasShadow" Value="True"/>
            <Setter Property="CornerRadius" Value="2"/>
        </Style>

        <Style TargetType="Image">
            <Setter Property="Aspect" Value="AspectFit"/>
            <Setter Property="Margin" Value="5"/>
        </Style>

        <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
        <converters:SquareColorToViewColorConverter x:Key="SquareColorToViewColorConverter" />
        <converters:RatingToBracketsConverter x:Key="RatingToBracketsConverter" />
        <converters:DraggingOpacityConverter x:Key="DraggingOpacityConverter" />
        <converters:DraggingPositionToRectConverter x:Key="DraggingPositionToRectConverter" />
    </ContentPage.Resources>
   

    <Grid RowDefinitions="Auto,Auto,Auto,Auto, Auto" 
          Padding="10"
          VerticalOptions="Fill"
          HorizontalOptions="Fill">

        <!-- Верхняя полоска с именем противника -->
        <Frame 
            Grid.Row="0"
            Padding="16,12"
            CornerRadius="14"
            BackgroundColor="{AppThemeBinding Light=#f5f7fb, Dark=#1a233b}"
            BorderColor="{AppThemeBinding Light=#e0e0e0, Dark=#404040}"
            VerticalOptions="Start"
            HorizontalOptions="Fill">

            <Frame.Shadow>
                <Shadow Brush="{AppThemeBinding Light=#30000000, Dark=#40FFFFFF}"
                        Offset="3,3"
                        Radius="12"/>
            </Frame.Shadow>
            <!-- Имя игрока -->
            <HorizontalStackLayout>
                <Image
                    Source="user_icon.png" 
                    Margin="0,0,10,0"
                    WidthRequest="24"
                    HeightRequest="24"
                    Aspect="AspectFit"/>

                <Label
                    Text="{Binding OpponentUsername}"
                    Margin="0,0,3,0"
                    FontSize="16"
                    TextColor="{AppThemeBinding Light=#2c3e50, Dark=White}"
                    FontFamily="OpenSansSemiBold"/>

                <Label
                    Text="{Binding OpponentRating, Converter={StaticResource RatingToBracketsConverter}}"
                    FontSize="12"
                    TextColor="{AppThemeBinding Light=#7f8c8d, Dark=#bdc3c7}"
                    FontFamily="OpenSansRegular"
            />
            </HorizontalStackLayout>
        </Frame>

        <!-- Chess Board 
        <Frame Grid.Row="1"
               CornerRadius="4"
               BorderColor="{AppThemeBinding Light=Black, Dark=White}"
               Padding="2">

            <Grid x:Name="ChessGrid"
                  VerticalOptions="Center"
                  HorizontalOptions="Center">
                
                <Grid.Behaviors>
                    <behaviors:BoardGridBehavior />
                </Grid.Behaviors>

                <CollectionView ItemsSource="{Binding FlatBoard}"
                                SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical"
                                         Span="8"
                                         HorizontalItemSpacing="0"
                                         VerticalItemSpacing="0"/>
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:BoardSquare">
                            <Grid>
                                <BoxView Color="{Binding Color, Converter={StaticResource SquareColorToViewColorConverter}}"
                                         InputTransparent="True"/>

                                <Image Source="{Binding Piece.Image}"
                                       IsVisible="{Binding Piece, Converter={StaticResource NullToBoolConverter}}"
                                       Opacity="{Binding IsDragging, Converter={StaticResource DraggingOpacityConverter}}">
                                    <Image.GestureRecognizers>
                                        <! Начало перетаскивания 
                                        <DragGestureRecognizer 
                                            CanDrag="True"
                                            DragStartingCommand="{Binding DragStartingCommand, Source={RelativeSource AncestorType={x:Type vm:GameViewModel}}}"
                                            DragStartingCommandParameter="{Binding Position}"
                                            />

                                        <! Область для дропа 
                                        <DropGestureRecognizer
                                            AllowDrop="True"
                                            DragOverCommand="{Binding DragOverCommand, Source={RelativeSource AncestorType={x:Type vm:GameViewModel}}}"
                                            DropCommand="{Binding DropCommand, Source={RelativeSource AncestorType={x:Type vm:GameViewModel}}}"/>
                                    </Image.GestureRecognizers>
                                </Image>

                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Frame> -->
        <Frame Grid.Row="1"
               CornerRadius="4"
               BorderColor="{AppThemeBinding Light=Black, Dark=White}"
               Padding="2">
            <AbsoluteLayout x:Name="BoardAbsoluteLayout"
                            VerticalOptions="CenterAndExpand"
                            HorizontalOptions="CenterAndExpand"
                            HeightRequest="360"
                            WidthRequest="360">
                <!-- Доска: CollectionView (или Grid) -->
                <CollectionView x:Name="BoardCollectionView"
                                ItemsSource="{Binding FlatBoard}"
                                SelectionMode="None"
                                AbsoluteLayout.LayoutBounds="0,0,1,1"
                                AbsoluteLayout.LayoutFlags="All">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical"
                                         Span="8"
                                         HorizontalItemSpacing="0"
                                         VerticalItemSpacing="0"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:BoardSquare">
                            <Grid>
                                <BoxView Color="{Binding Color, Converter={StaticResource SquareColorToViewColorConverter}}"
                                         InputTransparent="True"/>

                                <Ellipse BackgroundColor="Gray"
                                         IsVisible="{Binding CanMoveTo}"
                                         Margin="10">
                                </Ellipse>

                                <Image
                                    Source="{Binding Piece.Image}"
                                    IsVisible="{Binding Piece, Converter={StaticResource NullToBoolConverter}}"
                                    Opacity="{Binding IsDragging, Converter={StaticResource DraggingOpacityConverter}}"
                                    InputTransparent="False">
                                    <Image.GestureRecognizers>
                                        <PanGestureRecognizer
                                            
                                            PanUpdated="OnPiecePanUpdated"/>
                                    </Image.GestureRecognizers>
                                </Image>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <!-- Летающая фигура (поверх доски), если есть -->
                <Image
                    x:Name="DraggingPieceImage"
                    IsVisible="{Binding DraggingSquare, Converter={StaticResource NullToBoolConverter}}"
                    Source="{Binding DraggingSquare.Piece.Image}"
                    WidthRequest="{Binding CellSize}"
                    HeightRequest="{Binding CellSize}"
                    AbsoluteLayout.LayoutBounds="{Binding DraggingRect}"
                    />
            </AbsoluteLayout>
        </Frame>
        
        <Frame 
            Grid.Row="2"
            Padding="16,12"
            CornerRadius="14"
            BackgroundColor="{AppThemeBinding Light=#f5f7fb, Dark=#1a233b}"
            BorderColor="{AppThemeBinding Light=#e0e0e0, Dark=#404040}"
            VerticalOptions="Start"
            HorizontalOptions="Fill">

            <Frame.Shadow>
                <Shadow Brush="{AppThemeBinding Light=#30000000, Dark=#40FFFFFF}"
                        Offset="3,3"
                        Radius="12"/>
            </Frame.Shadow>
            <!-- Имя игрока -->
            <HorizontalStackLayout>
                <Image
                    Source="user_icon.png" 
                    Margin="0,0,10,0"
                    WidthRequest="24"
                    HeightRequest="24"
                    Aspect="AspectFit"/>

                <Label
                    Text="{Binding Username}"
                    Margin="0,0,3,0"
                    FontSize="16"
                    TextColor="{AppThemeBinding Light=#2c3e50, Dark=White}"
                    FontFamily="OpenSansSemiBold"/>

                <Label
                    Text="{Binding Rating, Converter={StaticResource RatingToBracketsConverter}}"
                    FontSize="12"
                    TextColor="{AppThemeBinding Light=#7f8c8d, Dark=#bdc3c7}"
                    FontFamily="OpenSansRegular"
                    />
            </HorizontalStackLayout>
        </Frame>

        <Label Grid.Row="3"
               Text="{Binding StatusMessage}"
               HorizontalOptions="Center"
               Margin="0,20"/>

        <Button Grid.Row="4"
                Text="Сдаться"
                HorizontalOptions="Center"
                Margin="0,10"
                WidthRequest="120"/>
    </Grid>
</ContentPage>